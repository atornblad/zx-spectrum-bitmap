<!DOCTYPE html>
<html>
    <head>
        <title>ZX Spectrum bitmap</title>
        <script src="zxsb.js"></script>
        <script src="zxbasic.js"></script>
        <script src="demos.js"></script>
        <link rel="stylesheet" href="zxsbdemo.css">
    </head>
    <body>
        <div>
            <canvas width="256" height="192" id="theCanvas"></canvas>
        </div>
        <select id="demos">
            <option>Select a demo...</option>
        </select>
        <br>
        <textarea id="source-code" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"> 10 REM Type a ZX Sinclair
 20 REM Spectrum BASIC program
 30 REM and click one of the
 40 REM RUN buttons.
 50 REM
 60 REM Supported commands:
 70 REM   LET, FOR, NEXT, GOTO,
 80 REM   GOSUB, RETURN, STOP,
 90 REM   INK, PAPER, OVER,
100 REM   INVERSE, FLASH,
110 REM   BRIGHT, PLOT, DRAW,
120 REM   CLS, POKE, PEEK,
130 REM   READ, DATA
140 REM
150 REM Not supported:
160 REM   Strings
170 REM   Attributed PLOT/DRAW
180 REM   Keyboard interaction
190 REM   Pausing / timing
200 REM   Sound
210 REM
220 REM Added commands:
230 REM   CSYS 1
240 REM      Normal ZX Spectrum
250 REM      coordinate system
260 REM   CSYS 0
270 REM      Reversed fullscreen
280 REM      coordinate system</textarea>
        <br>
        <button id="run-instant">RUN INSTANT</button>
        <button id="run-fast">RUN FAST</button>
        <button id="run-slow">RUN SLOW</button>
        <br>
        <label for="save-filename">SAVE</label> "<input type="text" maxlength="10" style="width:10.5em" id="save-filename" value="javascript">" SCREEN$ <button id="save">GO</button><br>
        <br>
        <script>
            var bitmap = new ZX.Spectrum.Bitmap({target : document.getElementById('theCanvas')});
            
            document.addEventListener('DOMContentLoaded', function() {
                var demos = document.getElementById('demos');
                var demoScripts = document.querySelectorAll('script');
                for (var i = 0; i < demoScripts.length; ++i) {
                    if (demoScripts[i].type != 'text/x-zx-spectrum-basic') continue;
                    var option = document.createElement('OPTION');
                    option.value = demoScripts[i].id;
                    option.textContent = demoScripts[i].title;
                    demos.appendChild(option);
                }
                
                document.getElementById('run-instant').addEventListener('click', function() {
                    ZX.Spectrum.Basic.run(document.getElementById('source-code').value, 1000);
                });
                
                document.getElementById('run-slow').addEventListener('click', function() {
                    ZX.Spectrum.Basic.run(document.getElementById('source-code').value, 1);
                });
                
                document.getElementById('run-fast').addEventListener('click', function() {
                    ZX.Spectrum.Basic.run(document.getElementById('source-code').value, 50);
                });
                
                demos.addEventListener('change', function() {
                    var script = document.getElementById(this.value);
                    if (script) {
                        document.getElementById('source-code').value = script.textContent;
                    }
                });
            });
            
            document.getElementById('save').addEventListener('click', function() {
                var filename = document.getElementById('save-filename').value;
                console.log(filename);
                
                var tapArray = new Uint8ClampedArray(25 + 6912);
                tapArray[0] = 19;                                          // Length of block, two bytes
                tapArray[1] = 0;
                tapArray[2] = 0;                                           // Block type = header block
                tapArray[3] = 3;                                           // File type = CODE
                for (var i = 0; i < 10; ++i) {                             // Filename (10 bytes)
                    var ascii = (i >= filename.length) ? 32 : filename.charCodeAt(i);
                    if (ascii < 32 || ascii > 127) ascii = 63;
                    tapArray[i + 4] = ascii;
                }
                tapArray[14] = (6912 & 0xff);                              // Length of data (2 bytes)
                tapArray[15] = (6912 >> 8);
                tapArray[16] = (16384 & 0xff);                             // Address of data (2 bytes)
                tapArray[17] = (16384 >> 8);
                tapArray[18] = 0;                                          // TAP parameter 2
                tapArray[19] = 128;
                tapArray[20] = (function() { var xor = 0; for (var i = 2; i <= 19; ++i) { xor ^= tapArray[i]; } return xor; })();
                
                tapArray[21] = (6912 + 2) & 0xff;
                tapArray[22] = (6912 + 2) >> 8;
                tapArray[23] = 0xff;
                for (var j = 0; j < 6912; ++j) {
                    tapArray[24 + j] = bitmap.peek(j + 16384);
                }
                tapArray[24 + 6912] = (function() { var xor = 0; for (var i = 23; i <= 23 + 6912; ++i) { xor ^= tapArray[i]; } return xor; })();
                
                var b64Encoded = btoa(String.fromCharCode.apply(null, tapArray));
                var url = 'data:application/x-spectrum-tap;base64,' + b64Encoded;
                var link = document.getElementById('download-link');
                if (!link) {
                    link = document.createElement('A');
                    link.id = 'download-link';
                    link.href = url;
                    link.download = (filename || 'output') + '.tap';
                    link.textContent = 'Click to download .TAP file';
                    link.addEventListener('click', function() {
                        window.setTimeout(function() {
                            link.parentNode.removeChild(link);
                        }, 10);
                    });
                    this.parentNode.insertBefore(link, this.nextSibling);
                    window.setTimeout(function() {
                        link.click();
                    }, 10);
                }
            });
        </script>

        <script type="text/x-zx-spectrum-basic" id="demo-random" title="Random">10 PAPER 0: INK 1: BRIGHT 1: CLS: CSYS 0
20 LET y = 95
30 FOR x = 0 TO 250 STEP 5
40 LET newy = RND * 180 + 6
50 PLOT x, y
60 DRAW 5, newy - y
70 LET y = newy
80 NEXT x</script>

        <script type="text/x-zx-spectrum-basic" id="demo-union-jack" title="Union Jack">  1 REM Slightly adapted from original
 
 10 LET r=2: LET w=7: LET b=1: CSYS 1
 20 PAPER b: INK w: CLS
 
 30 REM black in bottom of screen
 40 INVERSE 1: PAPER 0
 50 FOR n=40 TO -16 STEP -8
 55 PLOT 7,n: DRAW 241,0
 80 NEXT n: INVERSE 0: PAPER b
 
100 REM draw in white parts
105 REM St. George
110 FOR n=0 TO 7
120 PLOT 104 + n,175: DRAW 0,-35
130 PLOT 151 - n,175: DRAW 0,-35
140 PLOT 151 - n,48: DRAW 0,35
150 PLOT 104 + n,48: DRAW 0,35
160 NEXT n
200 FOR n=0 TO 11
210 PLOT 0, 139 - n: DRAW 111,0
220 PLOT 255, 139 - n: DRAW -111,0
230 PLOT 255, 84 + n: DRAW -111,0
240 PLOT 0, 84 + n: DRAW 111,0
250 NEXT n
 
300 REM St. Andrew
310 FOR n=0 TO 35
320 PLOT 1 + 2 * n, 175 - n: DRAW 32, 0
330 PLOT 224 - 2 * n, 175 - n: DRAW 16, 0
340 PLOT 254 - 2 * n, 48 + n: DRAW -32, 0 
350 PLOT 17 + 2 * n, 48 + n: DRAW 16, 0
360 NEXT n
370 FOR n = 0 TO 19
380 PLOT 185 + 2 * n, 140 + n: DRAW 32, 0 
390 PLOT 200 + 2 * n, 83 - n: DRAW 16, 0
400 PLOT 39 - 2 * n, 83 - n: DRAW 32, 0
410 PLOT 54 - 2 * n, 140 + n: DRAW -16, 0
420 NEXT n
 
425 REM fill in extra bits 
430 FOR n=0 TO 15
440 PLOT 255,160 + n: DRAW 2 * n - 30,0 
450 PLOT 0, 63 - n: DRAW 31 - 2 * n,0
460 NEXT n
470 FOR n=0 TO 7
480 PLOT 0, 160 + n: DRAW 14 - 2 * n,0
485 PLOT 255, 63 - n: DRAW 2 * n - 15,0 
490 NEXT n

500 REM red stripes 
510 INVERSE 1
 
520 REM St George
525 PAPER r
530 FOR n=96 TO 120 STEP 8
540 PLOT 7,n: DRAW 241,0 
550 NEXT n
560 FOR n=112 TO 136 STEP 8
570 PLOT n,168: DRAW 0,-113 
580 NEXT n
 
600 REM St Patrick
610 PLOT 170,140: DRAW 70,35 
620 PLOT 179,140: DRAW 70,35 
630 PLOT 199,83:  DRAW 56,-28 
640 PLOT 184,83:  DRAW 70,-35 
650 PLOT 86,83:   DRAW -70,-35 
660 PLOT 72,83:   DRAW -70,-35 
670 PLOT 56,140:  DRAW -56,28 
680 PLOT 71,140:  DRAW -70,35 
690 INVERSE 0: PAPER 0: INK 7</script>
        
        <script type="text/x-zx-spectrum-basic" id="demo-colour-wheel" title="Colour wheel"> 10 PAPER 7: INK 0: CSYS 1: BRIGHT 1: FLASH 0: CLS

100 FOR O = -10 TO 10
110 FOR H = 1 TO 12
120 INK H / 2 + 0.5
130 LET A = (H + O * 0.037) * 3.14159265358979 / 6
140 LET DX = SIN A: LET DY = COS A
150 PLOT 127 + 70 * DX, 83 + 70 * DY
160 DRAW 10 * DX, 10 * DY
170 NEXT H
180 NEXT O

200 LET X = 127: LET Y = 83
210 FOR A = 1 TO 300 STEP 0.1
220 LET X2 = 127 + A / 5 * SIN(A / 10)
230 LET Y2 = 83 + A / 5 * COS(A / 10)
240 INK A / 50 + 0.5: PLOT X, Y: DRAW X2 - X, Y2 - Y
250 LET X = X2: LET Y = Y2
260 NEXT A</script>
        
        <script type="text/x-zx-spectrum-basic" id="demo-logo" title="Logotype">  10 REM Clear screen and set up background colours
  20 PAPER 7: INK 0: FLASH 0: BRIGHT 0: CLS: CSYS 1
  30 FOR X = 6 TO 25
  40 FOR Y = 4 TO 5
  50 POKE 16384 + 6144 + 32 * Y + X, 64
  60 NEXT Y
  70 FOR Y = 6 TO 19
  80 POKE 16384 + 6144 + 32 * Y + X, 120
  90 NEXT Y
 100 NEXT X
 
 200 REM Outlines
 210 PLOT 47, 175 - 31
 220 DRAW 161, 0
 230 DRAW 0, -129
 240 DRAW -161, 0
 250 DRAW 0, 129
 260 BRIGHT 1
 270 PLOT 48, 127
 280 DRAW 159, 0
 
 400 REM Rainbow bands - red
 410 PAPER 0: INK 2
 420 FOR Y = 1 TO 7
 430 PLOT 168 - Y, 143 - Y
 440 DRAW Y - 1, 0
 450 PLOT 160 - Y, 135 - Y
 460 DRAW Y - 1, 0
 470 NEXT Y

 500 REM Rainbow bands - yellow
 510 PAPER 2: INK 6
 520 FOR Y = 1 TO 7
 530 PLOT 176 - Y, 143 - Y
 540 DRAW Y - 1, 0
 550 PLOT 168 - Y, 135 - Y
 560 DRAW Y - 1, 0
 570 NEXT Y

 600 REM Rainbow bands - green
 610 PAPER 6: INK 4
 620 FOR Y = 1 TO 7
 630 PLOT 184 - Y, 143 - Y
 640 DRAW Y - 1, 0
 650 PLOT 176 - Y, 135 - Y
 660 DRAW Y - 1, 0
 670 NEXT Y

 700 REM Rainbow bands - cyan
 710 PAPER 4: INK 5
 720 FOR Y = 1 TO 7
 730 PLOT 192 - Y, 143 - Y
 740 DRAW Y - 1, 0
 750 PLOT 184 - Y, 135 - Y
 760 DRAW Y - 1, 0
 770 NEXT Y
 780 PAPER 0
 790 FOR Y = 0 TO 7
 800 PLOT 192, 143 - Y
 810 DRAW 7 - Y, 0
 820 PLOT 184, 135 - Y
 830 DRAW 7 - Y, 0
 840 NEXT Y
 
 1000 REM Sinclair
 1010 INK 2: BRIGHT 0
 1020 LET Y = 143: LET thickness = 3
 1030 LET X = 52
 1040 READ dots
 1050 IF dots = -1 THEN GOTO 1150
 1060 IF dots = 0 THEN GOTO 1100
 1070 FOR y2 = Y TO Y - thickness + 1 STEP -1
 1080 PLOT X, y2: DRAW dots - 1, 0
 1090 NEXT y2
 1100 LET X = X + dots
 1110 READ space
 1120 IF space = -1 THEN GOTO 1150
 1130 LET X = X + space
 1140 GOTO 1040
 1150 LET Y = Y - thickness
 1160 LET thickness = 4 - thickness
 1170 IF Y >= 129 THEN GOTO 1030
 1180 DATA 0, 16, 3, 33, 3, 17, 3, -1
 1190 DATA 0, 52, 3, -1
 1200 DATA 15, 1, 3, 1, 15, 1, 15, 1, 3, 1, 15, 1, 3, 1, 15, -1
 1210 DATA 3, 13, 3, 1, 3, 9, 3, 1, 3, 13, 3, 13, 3, 1, 3, 1, 3, -1
 1220 DATA 15, 1, 3, 1, 3, 9, 3, 1, 3, 13, 3, 1, 15, 1, 3, 1, 3, -1
 1230 DATA 0, 12, 3, 1, 3, 1, 3, 9, 3, 1, 3, 13, 3, 1, 3, 9, 3, 1, 3, 1, 3, -1
 1240 DATA 15, 1, 3, 1, 3, 9, 3, 1, 15, 1, 3, 1, 15, 1, 3, 1, 3, -1</script>
    </body>
</html>