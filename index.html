<!DOCTYPE html>
<html>
    <head>
        <title>ZX Spectrum bitmap</title>
        <script src="zxsb.js"></script>
        <script src="zxbasic.js"></script>
        <script src="demos.js"></script>
        <link rel="stylesheet" href="zxsbdemo.css">
    </head>
    <body>
        <div>
            <canvas width="256" height="192" id="theCanvas"></canvas>
        </div>
        <select id="demos">
            <option>Select a demo...</option>
        </select>
        <br>
        <textarea id="source-code" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">10 PAPER 0: INK 1: BRIGHT 1: CLS
20 FOR x = 0 TO 255 STEP 5
30 PLOT x, 0
40 DRAW -x, 191 - x * 191 / 255
50 PLOT 255 - x, 191
60 DRAW x, x * 191 / 255 - 191
70 NEXT x</textarea>
        <br>
        <button id="run-instant">RUN INSTANT</button>
        <button id="run-fast">RUN FAST</button>
        <button id="run-slow">RUN SLOW</button>
        <br>
        <!--
        <button id="cls-test">CLS</button>
        <button id="speed-test">Speed POKE</button>
        <button id="plot-test">PLOT x 500</button>
        <button id="line-test">LINE x 10</button>
        <button id="logotype-test">Logotype</button>
        <br>
        <br>
        <label for="ink">INK</label> <input type="number" min="0" max="7" value="0" id="ink"><br>
        <label for="paper">PAPER</label> <input type="number" min="0" max="7" value="7" id="paper"><br>
        <label for="bright">BRIGHT</label> <input type="number" min="0" max="1" value="0" id="bright"><br>
        <label for="flash">FLASH</label> <input type="number" min="0" max="1" value="0" id="flash"><br>
        <br>
        <label for="poke-address">POKE</label> <input type="number" min="16384" max="23295" value="16384" id="poke-address">, <input type="number" min="0" max="255" value="0" id="poke-value"> <button id="poke">GO</button><br>
        <label for="peek-address">PEEK</label> <input type="number" min="16384" max="23295" value="16384" id="peek-address"> <button id="peek">GO</button> <span class="output" id="peek-result">?</span><br>
        <br>
        -->
        <label for="save-filename">SAVE</label> "<input type="text" maxlength="10" style="width:10.5em" id="save-filename" value="javascript">" SCREEN$ <button id="save">GO</button><br>
        <br>
        <script>
            var bitmap = new ZX.Spectrum.Bitmap({target : document.getElementById('theCanvas')});
            
            document.addEventListener('DOMContentLoaded', function() {
                var demos = document.getElementById('demos');
                var demoScripts = document.querySelectorAll('script');
                for (var i = 0; i < demoScripts.length; ++i) {
                    if (demoScripts[i].type != 'text/x-zx-spectrum-basic') continue;
                    var option = document.createElement('OPTION');
                    option.value = demoScripts[i].id;
                    option.textContent = demoScripts[i].title;
                    demos.appendChild(option);
                }
                
                document.getElementById('run-instant').addEventListener('click', function() {
                    ZX.Spectrum.Basic.run(document.getElementById('source-code').value, 1000);
                });
                
                document.getElementById('run-slow').addEventListener('click', function() {
                    ZX.Spectrum.Basic.run(document.getElementById('source-code').value, 1);
                });
                
                document.getElementById('run-fast').addEventListener('click', function() {
                    ZX.Spectrum.Basic.run(document.getElementById('source-code').value, 50);
                });
                
                demos.addEventListener('change', function() {
                    var script = document.getElementById(this.value);
                    if (script) {
                        document.getElementById('source-code').value = script.textContent;
                    }
                });
            });
            
            /*
            var intervalId;
            function stopInterval() {
                if (intervalId) {
                    window.clearInterval(intervalId);
                    intervalId = null;
                }
            }
            
            document.getElementById('speed-test').addEventListener('click', function() {
                stopInterval();
                intervalId = window.setInterval(function() {
                    var time = (performance.now() % 31415) / 100;
                    for (var i = time; i < time + 10; i += 0.01) {
                        var radius = 50 + Math.sin(i * 0.25) * 37;
                        
                        var x = 128 + radius * Math.sin(i * i * 2);
                        var y = 96 + radius * Math.cos(i * i * 2);
                        
                        var pointInfo = ZX.Spectrum.Bitmap.getPointInfo(x, y);
                        bitmap.poke(pointInfo.bitmapAddress, bitmap.peek(pointInfo.bitmapAddress) | pointInfo.bit);
                        bitmap.poke(pointInfo.attrAddress, 56);
                    }
                    
                    for (var i = 0; i < 50; ++i) {
                        var address = 16384 + (Math.random() * 6144) | 0;
                        var data = bitmap.peek(address) ^ ((Math.random() * 256) | 0);
                        
                        bitmap.poke(address, data);
                    }
                    
                    for (var i = 0; i < 10; ++i) {
                        var address = 16384 + 6144 + (Math.random() * 768) | 0;
                        var data = bitmap.peek(address) ^ ((Math.random() * 256) | 0);
                        
                        bitmap.poke(address, data);
                    }
                }, 1);
            });
            
            document.getElementById('plot-test').addEventListener('click', function() {
                stopInterval();
                for (var i = 0; i < 500; ++i) {
                    var x = Math.random() * 256;
                    var y = Math.random() * 192;
                    bitmap.plot(x, y);
                }
            });
            
            document.getElementById('line-test').addEventListener('click', function() {
                stopInterval();
                for (var i = 0; i < 10; ++i) {
                    var x1 = Math.random() * 256;
                    var y1 = Math.random() * 192;
                    var x2 = Math.random() * 256;
                    var y2 = Math.random() * 192;
                    bitmap.line(x1, y1, x2, y2);
                }
            });
            
            document.getElementById('cls-test').addEventListener('click', function() {
                stopInterval();
                bitmap.cls();
            });
            
            document.getElementById('logotype-test').addEventListener('click', function() {
                var i, x, y;
                
                stopInterval();
                bitmap.paper(7);
                bitmap.ink(0);
                bitmap.flash(0);
                bitmap.bright(0);
                bitmap.cls();
                
                for (var x = 6; x <= 25; ++x) {
                    for (y = 4; y <= 19; ++y) {
                        bitmap.poke(16384 + 6144 + 32 * y + x, (y <= 5) ? 64 : 120);
                    }
                }
                
                bitmap.line(47, 31, 208, 31);
                bitmap.line(47, 31, 47, 160);
                bitmap.line(208, 31, 208, 160);
                bitmap.line(47, 160, 208, 160);
                
                bitmap.bright(1);
                bitmap.line(48, 48, 207, 48);
                
                bitmap.bright(1);
                bitmap.paper(0);
                bitmap.ink(2);
                for (y = 1; y <= 7; ++y) {
                    bitmap.line(168 - y, y + 32, 167, y + 32);
                    bitmap.line(160 - y, y + 40, 159, y + 40);
                }
                
                bitmap.paper(2);
                bitmap.ink(6);
                for (y = 1; y <= 7; ++y) {
                    bitmap.line(176 - y, y + 32, 175, y + 32);
                    bitmap.line(168 - y, y + 40, 167, y + 40);
                }
                
                bitmap.paper(6);
                bitmap.ink(4);
                for (y = 1; y <= 7; ++y) {
                    bitmap.line(184 - y, y + 32, 183, y + 32);
                    bitmap.line(176 - y, y + 40, 175, y + 40);
                }
                
                bitmap.paper(4);
                bitmap.ink(5);
                for (y = 1; y <= 7; ++y) {
                    bitmap.line(192 - y, y + 32, 191, y + 32);
                    bitmap.line(184 - y, y + 40, 183, y + 40);
                }
                
                bitmap.paper(0);
                bitmap.ink(5);
                for (y = 0; y <= 7; ++y) {
                    bitmap.line(192, y + 32, 199 - y, y + 32);
                    bitmap.line(184, y + 40, 191 - y, y + 40);
                }
                
                bitmap.ink(2);
                bitmap.bright(0);
                var lines = [
                    [0, 16, 3, 33, 3, 17, 3],
                    [0, 52, 3],
                    [15, 1, 3, 1, 15, 1, 15, 1, 3, 1, 15, 1, 3, 1, 15],
                    [3, 13, 3, 1, 3, 9, 3, 1, 3, 13, 3, 13, 3, 1, 3, 1, 3],
                    [15, 1, 3, 1, 3, 9, 3, 1, 3, 13, 3, 1, 15, 1, 3, 1, 3],
                    [0, 12, 3, 1, 3, 1, 3, 9, 3, 1, 3, 13, 3, 1, 3, 9, 3, 1, 3, 1, 3],
                    [15, 1, 3, 1, 3, 9, 3, 1, 15, 1, 3, 1, 15, 1, 3, 1, 3]
                ];
                for (y = 32; y <= 46; ++y) {
                    var line = lines[(((y % 4) == 3) ? (y >> 1) : (y >> 2) << 1) - 16];
                    x = 52;
                    for (i = 0; i < line.length; i += 2) {
                        if (line[i]) {
                            bitmap.line(x, y, x + line[i] - 1, y);
                        }
                        x += (line[i] + line[i + 1]);
                    }
                }
                
                bitmap.paper(7);
                bitmap.bright(0);
                for (i = 0; i <= 125; i += 5) {
                    bitmap.ink(1);
                    bitmap.line(i, 0, 0, 125 - i);
                    bitmap.ink(2);
                    bitmap.line(255 - i, 191, 255, i + 66);
                }
                
                bitmap.ink(3);
                bitmap.bright(1);
                i = 0;
                var liner = function() {
                    x = 128 + 30 * Math.sin(i / 100) + 20 * Math.sin(i / 31 + 1);
                    y = 106 + 30 * Math.cos(i / 100) + 20 * Math.cos(i / 43 + 1);
                    bitmap.plot(x, y);
                    
                    ++i;
                    if (i < 1200) {
                        window.setTimeout(liner, 1);
                    } else {
                        bitmap.ink(document.getElementById('ink').value);
                        bitmap.paper(document.getElementById('paper').value);
                        bitmap.bright(document.getElementById('bright').value);
                        bitmap.flash(document.getElementById('flash').value);
                    }
                };
                
                liner();
            });
            
            document.getElementById('ink').addEventListener('change', function() {
                bitmap.ink(this.value);
            });
            
            document.getElementById('paper').addEventListener('change', function() {
                bitmap.paper(this.value);
            });
            
            document.getElementById('bright').addEventListener('change', function() {
                bitmap.bright(this.value);
            });
            
            document.getElementById('flash').addEventListener('change', function() {
                bitmap.flash(this.value);
            });
            
            document.getElementById('poke').addEventListener('click', function() {
                bitmap.poke(document.getElementById('poke-address').value, document.getElementById('poke-value').value);
            });
            
            document.getElementById('peek').addEventListener('click', function() {
                document.getElementById('peek-result').textContent = bitmap.peek(document.getElementById('peek-address'));
            });
            
            document.getElementById('save').addEventListener('click', function() {
                var filename = document.getElementById('save-filename').value;
                console.log(filename);
                
                var tapArray = new Uint8ClampedArray(25 + 6912);
                tapArray[0] = 19;                                          // Length of block, two bytes
                tapArray[1] = 0;
                tapArray[2] = 0;                                           // Block type = header block
                tapArray[3] = 3;                                           // File type = CODE
                for (var i = 0; i < 10; ++i) {                             // Filename (10 bytes)
                    var ascii = (i >= filename.length) ? 32 : filename.charCodeAt(i);
                    if (ascii < 32 || ascii > 127) ascii = 63;
                    tapArray[i + 4] = ascii;
                }
                tapArray[14] = (6912 & 0xff);                              // Length of data (2 bytes)
                tapArray[15] = (6912 >> 8);
                tapArray[16] = (16384 & 0xff);                             // Address of data (2 bytes)
                tapArray[17] = (16384 >> 8);
                tapArray[18] = 0;                                          // TAP parameter 2
                tapArray[19] = 128;
                tapArray[20] = (function() { var xor = 0; for (var i = 2; i <= 19; ++i) { xor ^= tapArray[i]; } return xor; })();
                
                tapArray[21] = (6912 + 2) & 0xff;
                tapArray[22] = (6912 + 2) >> 8;
                tapArray[23] = 0xff;
                for (var j = 0; j < 6912; ++j) {
                    tapArray[24 + j] = bitmap.peek(j + 16384);
                }
                tapArray[24 + 6912] = (function() { var xor = 0; for (var i = 23; i <= 23 + 6912; ++i) { xor ^= tapArray[i]; } return xor; })();
                
                var b64Encoded = btoa(String.fromCharCode.apply(null, tapArray));
                var url = 'data:application/x-spectrum-tap;base64,' + b64Encoded;
                var link = document.getElementById('download-link');
                if (!link) {
                    link = document.createElement('A');
                    link.id = 'download-link';
                    link.href = url;
                    link.download = (filename || 'output') + '.tap';
                    link.textContent = 'Click to download .TAP file';
                    link.addEventListener('click', function() {
                        window.setTimeout(function() {
                            link.parentNode.removeChild(link);
                        }, 1000);
                    });
                    this.parentNode.insertBefore(link, this.nextSibling);
                }
            });
            */
        </script>
        
        <script type="text/x-zx-spectrum-basic" id="demo-colours" title="Colours">10 REM Some colours...
20 PAPER 7: CLS
30 FOR x = 2 TO 252 STEP 9
40   FOR y = 7 TO 187 STEP 9
50     INK x: PAPER y
60     PLOT x, y: DRAW 1, 1
70   NEXT y
80 NEXT x</script>

        <script type="text/x-zx-spectrum-basic" id="demo-random" title="Random">10 PAPER 0: INK 1: BRIGHT 1: CLS
20 LET y = 95
30 FOR x = 0 TO 250 STEP 5
40 LET newy = RND * 180 + 6
50 PLOT x, y
60 DRAW 5, newy - y
70 LET y = newy
80 NEXT x</script>
        
        <script type="text/x-zx-spectrum-basic" id="demo-logo" title="Logotype">  10 REM Clear screen and set up background colours
  20 PAPER 7: INK 0: FLASH 0: BRIGHT 0: CLS
  30 FOR X = 6 TO 25
  40 FOR Y = 4 TO 5
  50 POKE 16384 + 6144 + 32 * Y + X, 64
  60 NEXT Y
  70 FOR Y = 6 TO 19
  80 POKE 16384 + 6144 + 32 * Y + X, 120
  90 NEXT Y
 100 NEXT X
 
 200 REM Outlines
 210 PLOT 47, 31
 220 DRAW 208 - 47, 0
 230 DRAW 0, 160 - 31
 240 DRAW 47 - 208, 0
 250 DRAW 0, 31 - 160
 260 BRIGHT 1
 270 PLOT 48, 48
 280 DRAW 207 - 48, 0
 
 400 REM Rainbow bands - red
 410 PAPER 0: INK 2
 420 FOR Y = 1 TO 7
 430 PLOT 168 - Y, Y + 32
 440 DRAW Y - 1, 0
 450 PLOT 160 - Y, Y + 40
 460 DRAW Y - 1, 0
 470 NEXT Y

 500 REM Rainbow bands - yellow
 510 PAPER 2: INK 6
 520 FOR Y = 1 TO 7
 530 PLOT 176 - Y, Y + 32
 540 DRAW Y - 1, 0
 550 PLOT 168 - Y, Y + 40
 560 DRAW Y - 1, 0
 570 NEXT Y

 600 REM Rainbow bands - green
 610 PAPER 6: INK 4
 620 FOR Y = 1 TO 7
 630 PLOT 184 - Y, Y + 32
 640 DRAW Y - 1, 0
 650 PLOT 176 - Y, Y + 40
 660 DRAW Y - 1, 0
 670 NEXT Y

 700 REM Rainbow bands - cyan
 710 PAPER 4: INK 5
 720 FOR Y = 1 TO 7
 730 PLOT 192 - Y, Y + 32
 740 DRAW Y - 1, 0
 750 PLOT 184 - Y, Y + 40
 760 DRAW Y - 1, 0
 770 NEXT Y
 780 PAPER 0
 790 FOR Y = 0 TO 7
 800 PLOT 192, Y + 32
 810 DRAW 7 - Y, 0
 820 PLOT 184, Y + 40
 830 DRAW 7 - Y, 0
 840 NEXT Y</script>
    </body>
</html>